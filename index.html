<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>the day of sign lv9</title>
		<meta name ="keywords" content="Sign,ccx01,sign,the day of sign,signXday,沙因,游戏,银河,宇宙,时间">
		<meta name="description" content="just for fun,及时行乐,核心思路是以时间空间为基础元素进行制作">
		<link rel="stylesheet" href="/lv9/css/main.css">
	</head>
	<body>
		<!-- <div class="loading">loading</div> -->

		<ul class="navi" data-state="0">
			<!-- <li class="item" data-page="nothing">nothing</li>
			<li class="item" data-page="random"><strong>time & space</strong></li> -->
			<li class="item" data-page="recent">recent</li>
			<li class="item" data-page="about"><h1>hi, I'm <strong>Sign</strong></h1></li>
			<li class="item close">
				X
			</li>
		</ul>
		<div id="view">
			<div id="main" class="layer"></div>
		</div>
		<!-- test -->
		<div class="test" style=" position: fixed; z-index: 99; bottom: 0;">
			rx: <input type="number" value="0">
			ry: <input type="number" value="0">
			rz: <input type="number" value="0">
			ra: <input type="number" value="0">
			rb: <input type="number" value="0">
			rc: <input type="number" value="0">
		</div>
		<script type="text/javascript">
			var input = document.querySelectorAll(".test input");
			var val = [];
			(function change(i) {
				if(i < input.length) {
					input[i].onchange = function() {
						val[i] = this.value | 0;
						test( val );
					}
					change( i + 1 );
				}
			}(0));
			function test(arr){
				var cir = {};
				var items = l1_items;
				var r = 250;
				var t = Math.random * 20;

				var rx = arr[0] * Math.PI / 180 || 0;
				var ry = arr[1] * Math.PI / 180 || 0;
				var rz = arr[2] * Math.PI / 180 || 0;

				(function fn(i){
					if(i < items.length){
						setTimeout(function(){
							// helix
							var phi = 2 * Math.PI * i / items.length;

							cir.x = r * Math.sin( phi );
							cir.y = r * Math.cos( phi ) * Math.sin( rx );
							cir.z = r * Math.cos( phi ) * Math.cos( rx );
							
							cir.a = arr[3] * Math.PI / 180 || 0;
							cir.b = arr[4] * Math.PI / 180 || 0;
							cir.c = arr[5] * Math.PI / 180 || 0;
							// console.log(cir.a,cir.b,cir.c,cir.x,cir.y,cir.z)

							var ro = toMatrix3d(cir);

							items[i].style.transform = "translate3d(-50%, -50%, 0) matrix3d(" + ro.join(",") + ")";

							fn(i + 1);
						}, t);
					}
				}(0));
			}

		</script>

		<!-- tamplate -->
		<div id="content">
			<svg class="icon icon-close" viewBox="0 0 32 32">
				<use xlink:href="#icon-close"></use>
			</svg>
			<div class="wrap">
				<p>数据正在接入</p>	
			</div>
		</div>
		<template id="layout-tpl">
			<h2 class="title">{#words}</h2>
			<p class="info" data-info='{"id": {#id}, "toid": {#tid}}'>{#name} @ {#time}</p>
			<div class="media">{#other}</div>
		</template>
		<template id="tpl">
			<div class="item">
				<span class="num" data-index="{#index}">{#n}</span>
			</div>
		</template>
		<!-- tamplate end -->
		<script>
			/* common */
			var $ = function(elem){
				var ret = document.querySelectorAll(elem);
				return ret.length == 1 ? ret[0] : ret;
			}
			document.onselectstart = function() {
				return false;
			}
			document.oncontextmenu = function() {
				return false;
			}

			/* gesture */
			var $main = $('#main');
			var gesture = 0;
			var ex = 0;
			var ey = 0;

			var layout = (function() {
				var I = {};
				I.la = I.a = 0;
				I.lb = I.b = 0;
				I.lc = I.c = 0;
				I.lx = I.x = 0;
				I.ly = I.y = 0;
				I.lz = I.z = 0;

				return I;
			}());

			$('#view').style.width = document.body.offsetWidth + "px";
			$('#view').style.height = document.body.offsetHeight + "px";
			
			$('#view').onmousedown = function(e) {
				ex = e.layerX;
				ey = e.layerY;
				gesture = 1;
			}
			$('#view').onmousemove = function(e) {
				if(gesture) {
					switch(e.which) {
						case 1:
							layout.a = layout.la + (ey - e.layerY) / 100;
							layout.b = layout.lb + (ex - e.layerX) / 100;
							// c = lc + (ex - e.layerY) / 100;
							var ro = toMatrix3d(layout);
							$main.style.transform = "matrix3d(" + ro.join(",") + ")";
						break;
						case 3:
							layout.x = layout.lx + e.layerX - ex;
							layout.y = layout.ly + e.layerY - ey;

							var ro = toMatrix3d(layout);
							$main.style.transform = "matrix3d(" + ro.join(",") + ")";
						break;
					}
				}
			}
			$('#view').onmouseup = function(e) {
				layout.la = layout.a;
				layout.lb = layout.b;
				layout.lc = layout.c;
				layout.lx = layout.x;
				layout.ly = layout.y;
				gesture = 0;
			}

			document.onmousewheel = function(e) {
				layout.z += e.wheelDelta;
				var ro = toMatrix3d(layout);
				$main.style.transform = "matrix3d(" + ro.join(",") + ")";
			}

			/* init layout */
			var $content = $('#content');
			var $navi = $('.navi');
			var tpl = $('#tpl').innerHTML;
			var sign = ["Ⅰ", "Ⅱ", "Ⅲ", "Ⅳ", "Ⅴ", "Ⅵ", "Ⅶ", "Ⅷ", "Ⅸ", "Ⅹ", "Ⅺ", "Ⅻ"];

			var $l1 = $('.l1');
			var l1_items;

			setTimeout(function() {
				switchState($navi, 1);
			}, 100);
			var l1 = function(){
				l1_items = initHTML('#main', 12);
				circle(l1_items, 550, 10);
			}

			l1();

			var ajax_data = {
				'l1': [],
				'l2': []
			};
			var l1_tpl = $('#layout-tpl').innerHTML;
			$l1.onclick = function(e){
				var ajax_index = e.target.dataset['index'];
				if(ajax_data.l1[ajax_index]) {
					$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + ajax_data.l1[ajax_index];
					switchState([$content], 1);
				} else {
					ajax("sort=words&index=" + ajax_index, function(data) {
						data = tplEngine(l1_tpl, data);
						ajax_data.l1[ajax_index] = data;
						$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + data;
						switchState([$content], 1);
					});
				}
			}

			/* init menu */

			/* function */

			function ajax(data, callback) {
				var url = "/data/data.php?" + data;
				var xmlhttp = new XMLHttpRequest();
					xmlhttp.open("POST", url, true);
					xmlhttp.send();

				xmlhttp.onreadystatechange = function() {
					if(xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						callback && callback(JSON.parse(xmlhttp.responseText));
					}
				}
			}

			function switchState(elems, num){
				if(elems.length){
					for(var i = 0; i < elems.length; i++){
						elems[i].dataset['state'] = num;
					}
				}else{
					elems.dataset['state'] = num;
				}
			}

			function callPage(page){
				switchState([$l1, $l2, $l3, $l4], 2);
				switch(page){
					case 'nothing':
						alert('I told u.');
						break;
					case 'recent':
						switchState($l2, 1);
						switchState($navi, 'recent');
						scat(l2_items, 6, function(){
							setTimeout(function(){
								switchState($l2, 3);
							}, 1000);
						});
						break;
					case 'about':
						switchState($l1, 1);
						switchState($navi, 'about');
						break;
				}
			}

			function initHTML(layer, num){
				var dom = $(layer);
				var html = '';
				for (var i = 0; i < num; i++) {
					data = {
						index: i,
						n: sign[i % sign.length]
					}
					html += tplEngine(tpl, data);
				}
				dom.innerHTML = html;
				return dom.querySelectorAll('.item');
			}

			function circle(items, r, t, callback){
				if(typeof(arguments[2]) == 'function'){
					var callback = arguments[2];
					var t = 100;
				}else{
					var callback = callback || function(){};
					var t = t || 100;
				}
				var cir = {};
				(function fn(i){
					if(i < items.length){
						setTimeout(function(){

							var phi = Math.acos( -1 + ( 2 * i ) / items.length );
							var theta = Math.sqrt( items.length * Math.PI ) * phi;

							cir.x = 250 * Math.cos( theta ) * Math.sin( phi );
							cir.y = 250 * Math.sin( theta ) * Math.sin( phi );
							cir.z = 250 * Math.cos( phi );

							// layout rotate

							// cir.x = 200 * Math.sin( phi );
							// cir.y = 200 * Math.cos( phi );
							// cir.z = 200 * Math.cos( phi );

							// item rotate
							cir.a = Math.atan2(cir.y, cir.z);
							cir.b = Math.atan2(cir.z, cir.x) - Math.PI * 0.5;
							cir.c = Math.atan2(cir.x, cir.y);
							
							if(cir.a > Math.PI * 0.5) {
								cir.a *= -1;
							}
							// cir.a = 0;
							// cir.b = 0;
							cir.c = 0;
							// console.log(cir.a,cir.b,cir.c,cir.x,cir.y,cir.z)

							var ro = toMatrix3d(cir);

							items[i].style.transform = "translate3d(-50%, -50%, 0) matrix3d(" + ro.join(",") + ")";

							fn(i + 1);
						}, t);
					}else{
						callback();
					}
				}(0));
			}

			function scat(items, col, callback){
				var callback = callback || function(){};
				var col = col || 6;
				var row = items.length / col;
				var w = window.innerWidth / col;
				var h = window.innerHeight / row;
				(function fn(i){
					if(i < items.length){
						var x = (i % col - col / 2) * w;
						var y = (i % row - row / 2) * h;
						var z = (Math.random() * 500 - 250);
						items[i].style.transform = 'translate3d(' + x + 'px, ' + y + 'px, ' + z + 'px)';
						fn(i + 1);
					}else{
						callback();
					}
				}(0));
			}

			function toMatrix3d(m) {
				var sa = Math.sin(m.a).toFixed(3);
				var ca = Math.cos(m.a).toFixed(3);
				var sb = Math.sin(m.b).toFixed(3);
				var cb = Math.cos(m.b).toFixed(3);
				var sc = Math.sin(m.c).toFixed(3);
				var cc = Math.cos(m.c).toFixed(3);

				var x = m.x.toFixed(3);
				var y = m.y.toFixed(3);
				var z = m.z.toFixed(3);

				var rx = [
					[1, 0, 0, 0],
					[0, ca, -sa, 0],
					[0, sa, ca, 0],
					[0, 0, 0, 1]
				];

				var ry = [
					[cb, 0, sb, 0],
					[0, 1, 0, 0],
					[-sb, 0, cb, 0],
					[0, 0, 0, 1]
				];

				var rz = [
					[cc, -sc, 0, 0],
					[sc, cc, 0, 0],
					[0, 0, 1, 0],
					[0, 0, 0, 1]
				];

				var tl = [
					[1, 0, 0, 0],
					[0, 1, 0, 0],
					[0, 0, 1, 0],
					[x, y, z, 1]
				];

				var ro = matrixX([rx, ry, rz, tl]);

				return ro;
			}

			function matrixX(matrixs) {

				var a = matrixs[0];

				for(var mtx = 1; mtx < matrixs.length; mtx++) {
					var b = matrixs[mtx];

					var i = 0,
						j = 0,
						k = 0;

					var m = a.length, //col
						n = b.length, //common
						p = b[0].length; //row

					var sum = 0;
					var c = [];

					while (i < m) {
						c[i] = [];
						j = 0;
						while (j < p) {
							k = 0;
							sum = 0;
							while (k < n) {
								sum += a[i][k] * b[k][j];
								k++;
							}
							c[i][j] = sum;
							j++;
						}
						i++;
					}

					a = c;
				}

				return a;
			}

			function tplEngine(tpl, data) {
				var re = /{#(\w+)?}/;
				while(match = re.exec(tpl)) {
					tpl = tpl.replace(match[0],data[match[1]]);
				}
				return tpl;
			}
		</script>
	</body>
</html>
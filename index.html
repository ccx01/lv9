<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>the day of sign lv9</title>
		<meta name ="keywords" content="Sign,ccx01,sign,the day of sign,signXday,沙因,游戏,银河,宇宙,时间">
		<meta name="description" content="just for fun,及时行乐,核心思路是以时间空间为基础元素进行制作">
		<link rel="stylesheet" href="/lv9/css/main.css">
	</head>
	<body>
		<!-- <div class="loading">loading</div> -->
		<!-- svg -->
		<svg display="none"  width="32" height="32" viewBox="0 0 32 32">
			<defs>
				<g id="icon-close">
					<path class="path1" d="M31.708 25.708c-0-0-0-0-0-0l-9.708-9.708 9.708-9.708c0-0 0-0 0-0 0.105-0.105 0.18-0.227 0.229-0.357 0.133-0.356 0.057-0.771-0.229-1.057l-4.586-4.586c-0.286-0.286-0.702-0.361-1.057-0.229-0.13 0.048-0.252 0.124-0.357 0.228 0 0-0 0-0 0l-9.708 9.708-9.708-9.708c-0-0-0-0-0-0-0.105-0.104-0.227-0.18-0.357-0.228-0.356-0.133-0.771-0.057-1.057 0.229l-4.586 4.586c-0.286 0.286-0.361 0.702-0.229 1.057 0.049 0.13 0.124 0.252 0.229 0.357 0 0 0 0 0 0l9.708 9.708-9.708 9.708c-0 0-0 0-0 0-0.104 0.105-0.18 0.227-0.229 0.357-0.133 0.355-0.057 0.771 0.229 1.057l4.586 4.586c0.286 0.286 0.702 0.361 1.057 0.229 0.13-0.049 0.252-0.124 0.357-0.229 0-0 0-0 0-0l9.708-9.708 9.708 9.708c0 0 0 0 0 0 0.105 0.105 0.227 0.18 0.357 0.229 0.356 0.133 0.771 0.057 1.057-0.229l4.586-4.586c0.286-0.286 0.362-0.702 0.229-1.057-0.049-0.13-0.124-0.252-0.229-0.357z"></path>
				</g>
			</defs>
		</svg>

		<div id="main">
			<ul class="navi">
				<!-- <li class="item" data-page="nothing">nothing</li>
				<li class="item" data-page="random"><strong>time & space</strong></li> -->
				<li class="item" data-page="recent">recent</li>
				<li class="item" data-page="about"><h1>hi, I'm <strong>Sign</strong></h1></li>
				<li class="close">
					<svg class="icon icon-close" viewBox="0 0 32 32">
						<use xlink:href="#icon-close"></use>
					</svg>
				</li>
			</ul>
			<div class="layer l1 about"></div>
			<div class="layer l2 recent"></div>
			<div class="layer l3 random"></div>
			<div class="layer l4 nothing"></div>
		</div>
		<!-- tamplate -->
		<div id="content">
			<svg class="icon icon-close" viewBox="0 0 32 32">
				<use xlink:href="#icon-close"></use>
			</svg>
			<div class="wrap">
				<p>数据正在接入</p>	
			</div>
		</div>
		<template id="l1-tpl">
			<h2 class="title">{#words}</h2>
			<p class="info" data-info='{"id": {#id}, "toid": {#tid}}'>{#name} @ {#time}</p>
			<div class="media">{#other}</div>
		</template>
		<template id="tpl">
			<div class="item">
				<span class="num" data-index="{#index}">{#n}</span>
			</div>
		</template>
		<!-- tamplate end -->
		<script>
			var $ = function(dom){
				var ret = document.querySelectorAll(dom);
				return ret.length == 1 ? ret[0] : ret;
			}

			/* init layout */
			var $content = $('#content');
			var $navi = $('.navi');
			var tpl = $('#tpl').innerHTML;
			var sign = ["Ⅰ", "Ⅱ", "Ⅲ", "Ⅳ", "Ⅴ", "Ⅵ", "Ⅶ", "Ⅷ", "Ⅸ", "Ⅹ", "Ⅺ", "Ⅻ"];

			var $l1 = $('.l1');
			var $l2 = $('.l2');
			var $l3 = $('.l3');
			var $l4 = $('.l4');
			var l1_items;
			var	l2_items;
			var	l3_items;
			var	l4_items;

			var l1 = function(){
				l1_items = initHTML('.l1', 12);
				circle(l1_items, 270, 50, l2);
			}
			var l2 = function(){
				l2_items = initHTML('.l2', 24);
				circle(l2_items, 340, 30, l3);
			}
			var l3 = function(){
				l3_items = initHTML('.l3', 36);
				circle(l3_items, 450, 10, l4);
			}
			var l4 = function(){
				l4_items = initHTML('.l4', 48);
				circle(l4_items, 550, 10, function(){
					switchState($navi, 1);
					switchState([$l1, $l2, $l3, $l4], 0);
				});
			}

			l1();

			var ajax_data = {
				'l1': [],
				'l2': []
			};
			var l1_tpl = $('#l1-tpl').innerHTML;
			$l1.onclick = function(e){
				var ajax_index = e.target.dataset['index'];
				if(ajax_data.l1[ajax_index]) {
					$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + ajax_data.l1[ajax_index];
					switchState([$content], 1);
				} else {
					ajax("sort=words&index=" + ajax_index, function(data) {
						data = tplEngine(l1_tpl, data);
						ajax_data.l1[ajax_index] = data;
						$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + data;
						switchState([$content], 1);
					});
				}
			}

			$l2.onclick = function(e){
				var ajax_index = e.target.dataset['index'];
				if(ajax_data.l2[ajax_index]) {
					$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + ajax_data.l2[ajax_index];
				} else {
					ajax("sort=video&index=" + ajax_index, function(data) {
						data = tplEngine(l1_tpl, data);
						ajax_data.l2[ajax_index] = data;
						$('#content .wrap').innerHTML = e.target.innerText + ':<br>' + data;
					});
				}
				switchState([$content], 2);
			}
			$l2.onmouseover = function(e) {
				var pos = e.target.parentNode.style.transform.replace(/(-*\d+)px/g, function(m, s){
					return (-1 * s) + 'px';
				});
				$l2.style.transform = pos;
			}

			/* init menu */
			var $menu = $('.navi .item');
			for(var i = 0; i < $menu.length; i++){
				$menu[i].onclick = function(){
					callPage(this.dataset['page']);
				}
			}
			var $navi_close = $('.navi .close');
			$navi_close.onclick = function(){
				switch($navi.dataset['state']){
					case 'recent':
						circle(l2_items, 340, 50);
						$l2.style.transform = '';
						break;
				}
				switchState($navi, 1);
				switchState([$l1, $l2, $l3, $l4], 0);
			}

			$('#content .icon-close').onclick = function(){
				switchState([$content], 0);
			}

			function ajax(data, callback) {
				var url = "/data/data.php?" + data;
				var xmlhttp = new XMLHttpRequest();
					xmlhttp.open("POST", url, true);
					// xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xmlhttp.send();

				xmlhttp.onreadystatechange = function() {
					if(xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						callback && callback(JSON.parse(xmlhttp.responseText));
					}
				}
			}

			function switchState(doms, num){
				if(doms.length){
					for(var i = 0; i < doms.length; i++){
						doms[i].dataset['state'] = num;
					}
				}else{
					doms.dataset['state'] = num;
				}
			}

			function callPage(page){
				switchState([$l1, $l2, $l3, $l4], 2);
				switch(page){
					case 'nothing':
						alert('I told u.');
						break;
					case 'recent':
						switchState($l2, 1);
						switchState($navi, 'recent');
						scat(l2_items, 6, function(){
							setTimeout(function(){
								switchState($l2, 3);
							}, 1000);
						});
						break;
					case 'about':
						switchState($l1, 1);
						switchState($navi, 'about');
						break;
				}
			}

			function initHTML(layer, num){
				var dom = $(layer);
				var html = '';
				for (var i = 0; i < num; i++) {
					data = {
						index: i,
						n: sign[i % sign.length]
					}
					html += tplEngine(tpl, data);
				}
				dom.innerHTML = html;
				return dom.querySelectorAll('.item');
			}

			function circle(items, r, t, callback){
				var x;
				var y;
				var rotate;
				var deg = 360 / items.length;
				if(typeof(arguments[2]) == 'function'){
					var callback = arguments[2];
					var t = 100;
				}else{
					var callback = callback || function(){};
					var t = t || 100;
				}
				(function fn(i){
					if(i < items.length){
						setTimeout(function(){
							x =  (i == items.length * 0.5) ? 0 : Math.sin(i * 2 * Math.PI / items.length) * r;
							y =  (i == items.length * 0.75 || i == items.length * 0.25) ? 0 : -Math.cos(i * 2 *  Math.PI / items.length) * r;
							z =  0;
							rotate = deg * i;
							items[i].style.transform = 'translate3d(' + x + 'px, ' + y + 'px, ' + z + 'px) rotate(' + rotate + 'deg)';
							items[i].style.opacity = 1;
							fn(i + 1);
						}, t);
					}else{
						callback();
					}
				}(0));
			}

			function scat(items, col, callback){
				var callback = callback || function(){};
				var col = col || 6;
				var row = items.length / col;
				var w = window.innerWidth / col;
				var h = window.innerHeight / row;
				(function fn(i){
					if(i < items.length){
						var x = (i % col - col / 2) * w | 0;
						var y = (i % row - row / 2) * h | 0;
						var z = (Math.random() * 500 - 250) | 0;
						items[i].style.transform = 'translate3d(' + x + 'px, ' + y + 'px, ' + z + 'px)';
						fn(i + 1);
					}else{
						callback();
					}
				}(0));
			}

			function tplEngine(tpl, data) {
				var re = /{#(\w+)?}/;
				while(match = re.exec(tpl)) {
					tpl = tpl.replace(match[0],data[match[1]]);
				}
				return tpl;
			}
		</script>
	</body>
</html>